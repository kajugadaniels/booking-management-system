{% extends 'layouts/app.html' %}

{% block content %}
    <section class="layout-radius pt-5 pb-5">
        <div class="boxcar-container text-center">
            <h2 class="mb-4">Complete Your Payment</h2>
            <p class="lead mb-4">Booking: {{ payment.booking.room.name }} at {{ payment.booking.room.hotel.name }}</p>
            <p class="mb-3">Total: <strong>${{ payment.booking.total_price }}</strong></p>

            <button onclick="startPayment()" class="side-btn">
                Proceed to Pay
            </button>
        </div>
    </section>

    <!-- IremboPay Inline Script -->
    <script src="https://dashboard.sandbox.irembopay.com/assets/payment/inline.js"></script>

    <script>
        function startPayment() {
            const publicKey = "{{ public_key }}";
            const invoiceNumber = "{{ payment.invoice_number }}";

            console.log("üöÄ Initiating IremboPay...");
            console.log("Public Key:", publicKey);
            console.log("Invoice Number:", invoiceNumber);

            IremboPay.initiate({
                publicKey: publicKey,
                invoiceNumber: invoiceNumber,
                locale: IremboPay.locale.EN,
                callback: function (err, resp) {
                    console.log("üßæ IremboPay Callback Triggered");
                    console.log("‚ùå Error:", err);
                    console.log("üìã Response:", resp);

                    if (!err && resp?.payment_status === 'success') {
                        alert("‚úÖ Payment successful!");
                        window.location.href = "{% url 'hotel:roomDetails' payment.booking.room.hotel.id payment.booking.room.id %}";
                    } else {
                        alert("‚ùå Payment cancelled or failed. See console for details.");
                    }
                }
            });
        }
    </script>
{% endblock %}
