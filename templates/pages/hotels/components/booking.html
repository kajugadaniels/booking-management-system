<script src="https://dashboard.sandbox.irembopay.com/assets/payment/inline.js"></script>

{% if user.is_authenticated %}
<form method="POST" class="contact-box-two v2">
    {% csrf_token %}
    <span>Price Per Night</span>
    <h3 class="title">${{ room.price_per_night }}</h3>

    {{ booking_form.non_field_errors }}
    <div class="row">
        <div class="col-lg-6">
            <div class="form_boxes">
                {{ booking_form.check_in.label_tag }} {{ booking_form.check_in }}
                {{ booking_form.check_in.errors }}
            </div>
        </div>
        <div class="col-lg-6">
            <div class="form_boxes">
                {{ booking_form.check_out.label_tag }} {{ booking_form.check_out }}
                {{ booking_form.check_out.errors }}
            </div>
        </div>
        <div class="col-lg-12">
            <div class="form_boxes">
                {{ booking_form.guests.label_tag }} {{ booking_form.guests }}
                {{ booking_form.guests.errors }}
            </div>
        </div>
        <div class="col-lg-12">
            <div class="form_boxes">
                {{ booking_form.special_requests.label_tag }} {{ booking_form.special_requests }}
            </div>
        </div>
    </div>

    <div class="total-price mt-3 mb-2">
        <strong>Total Price: $<span id="total-price">0.00</span></strong>
    </div>

    <div class="btn-box">
        <button type="submit" class="side-btn">Create Booking</button>
    </div>
</form>

{% if invoice_number %}
<div class="mt-4">
    <button type="button" class="side-btn" onclick="startPayment()">
        Pay Now
    </button>
</div>
{% endif %}

<script>
    function startPayment() {
        const invoice = "{{ invoice_number }}";
        const publicKey = "pk_live_a780e931399b42f6a135dd09e897ec32";

        if (!invoice) {
            alert("Invoice not found.");
            return;
        }

        IremboPay.initiate({
            publicKey: publicKey,
            invoiceNumber: invoice,
            locale: IremboPay.locale.EN,
            callback: function (err, resp) {
                if (!err && resp?.payment_status === 'success') {
                    alert("Payment successful. Reloading...");
                    window.location.reload();
                } else {
                    alert("Payment cancelled or failed.");
                }
            }
        });
    }

    document.addEventListener("DOMContentLoaded", function () {
        const checkInInput = document.getElementById("id_check_in");
        const checkOutInput = document.getElementById("id_check_out");
        const guestsInput = document.getElementById("id_guests");
        const pricePerNight = parseFloat("{{ room.price_per_night }}");
        const maxGuests = {{ room.occupancy }};
        const totalPriceDisplay = document.getElementById("total-price");

        const today = new Date().toISOString().split("T")[0];
        checkInInput.setAttribute("min", today);
        checkOutInput.setAttribute("min", today);

        function calculateTotal() {
            const checkIn = new Date(checkInInput.value);
            const checkOut = new Date(checkOutInput.value);
            const timeDiff = checkOut - checkIn;
            const nights = timeDiff / (1000 * 60 * 60 * 24);

            if (nights > 0) {
                const total = nights * pricePerNight;
                totalPriceDisplay.textContent = total.toFixed(2);
            } else {
                totalPriceDisplay.textContent = "0.00";
            }
        }

        checkInInput.addEventListener("change", function () {
            checkOutInput.setAttribute("min", checkInInput.value);
            calculateTotal();
        });

        checkOutInput.addEventListener("change", calculateTotal);

        guestsInput.addEventListener("input", function () {
            let val = parseInt(guestsInput.value);
            if (val > maxGuests) {
                guestsInput.value = maxGuests;
                alert(`This room allows up to ${maxGuests} guest${maxGuests > 1 ? 's' : ''}.`);
            } else if (val < 1) {
                guestsInput.value = 1;
            }
        });
    });
</script>
{% else %}
    <a href="{% url 'auth:getLogin' %}" class="side-btn">Login to Book</a>
{% endif %}


<script>
    document.addEventListener("DOMContentLoaded", function () {
        const checkInInput = document.getElementById("id_check_in");
        const checkOutInput = document.getElementById("id_check_out");
        const guestsInput = document.getElementById("id_guests");
        const pricePerNight = parseFloat("{{ room.price_per_night }}");
        const maxGuests = {{ room.occupancy }};
        const totalPriceDisplay = document.getElementById("total-price");

        // Disable past dates for check-in and check-out
        const today = new Date().toISOString().split("T")[0];
        checkInInput.setAttribute("min", today);
        checkOutInput.setAttribute("min", today);

        // Calculate total price
        function calculateTotal() {
            const checkIn = new Date(checkInInput.value);
            const checkOut = new Date(checkOutInput.value);
            const timeDiff = checkOut - checkIn;
            const nights = timeDiff / (1000 * 60 * 60 * 24);

            if (nights > 0) {
                const total = nights * pricePerNight;
                totalPriceDisplay.textContent = total.toFixed(2);
            } else {
                totalPriceDisplay.textContent = "0.00";
            }
        }

        checkInInput.addEventListener("change", function () {
            checkOutInput.setAttribute("min", checkInInput.value);
            calculateTotal();
        });

        checkOutInput.addEventListener("change", calculateTotal);

        // Restrict guests to room occupancy
        guestsInput.addEventListener("input", function () {
            let val = parseInt(guestsInput.value);
            if (val > maxGuests) {
                guestsInput.value = maxGuests;
                alert(`This room only allows up to ${maxGuests} guest${maxGuests > 1 ? 's' : ''}.`);
            } else if (val < 1) {
                guestsInput.value = 1;
            }
        });
    });
</script>